# ============================================
# Load Balancing dengan External Database
# ============================================

---
# Ingress untuk External Traffic
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: layanan-ingress
  namespace: layanan-prod
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - layanan.diskominfo.kaltaraprov.go.id
    secretName: layanan-tls
  rules:
  - host: layanan.diskominfo.kaltaraprov.go.id
    http:
      paths:
      # Email Service
      - path: /api/email
        pathType: Prefix
        backend:
          service:
            name: email-service
            port:
              number: 80

      # Subdomain Service
      - path: /api/subdomain
        pathType: Prefix
        backend:
          service:
            name: subdomain-service
            port:
              number: 80

      # Auth Service
      - path: /api/auth
        pathType: Prefix
        backend:
          service:
            name: auth-service
            port:
              number: 80

# ============================================
# Traffic Flow dengan External DB:
# ============================================
#
# Internet
#   │
#   ▼
# Load Balancer (cloud provider)
#   │
#   ▼
# Ingress Controller (nginx)
#   │
#   ├──► Email Service Pod 1 ──┐
#   ├──► Email Service Pod 2 ──┼──► mysql-external Service
#   ├──► Email Service Pod 3 ──┘         │
#   │                                     ▼
#   ├──► Subdomain Service Pod 1 ────► External MySQL (10.0.2.100)
#   ├──► Subdomain Service Pod 2 ────►
#   │
#   └──► Auth Service Pod 1-3 ────────►
#
# Load balancing terjadi di APPLICATION LAYER
# Database connection pooling handle DB load

---
# Service dengan Session Affinity (Sticky Sessions)
# Jika butuh client tetap ke pod yang sama
apiVersion: v1
kind: Service
metadata:
  name: email-service-sticky
  namespace: layanan-prod
spec:
  selector:
    app: email-service
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8000
  sessionAffinity: ClientIP  # Sticky session based on client IP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
