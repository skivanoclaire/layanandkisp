# ============================================
# Resource Management
# Database eksternal = Fixed cost
# App pods = Dynamic scaling dengan limits
# ============================================

---
# Namespace Resource Quota
# Limit total resource untuk semua pods di namespace
apiVersion: v1
kind: ResourceQuota
metadata:
  name: layanan-quota
  namespace: layanan-prod
spec:
  hard:
    # Total limits untuk seluruh namespace
    requests.cpu: "20"       # Total 20 CPU cores
    requests.memory: "40Gi"  # Total 40GB RAM
    limits.cpu: "40"         # Max 40 CPU cores
    limits.memory: "80Gi"    # Max 80GB RAM

    # Object counts
    pods: "100"              # Max 100 pods
    services: "30"           # Max 30 services
    persistentvolumeclaims: "10"  # Max 10 PVCs

# ============================================
# Keuntungan dengan External DB:
# ============================================
#
# Resource Allocation:
# ┌────────────────────────────────────────┐
# │  Kubernetes Cluster (100 GB RAM)      │
# ├────────────────────────────────────────┤
# │  App Pods: 40-80 GB (dynamic)          │
# │  - Email Service: 10-20 GB             │
# │  - Subdomain: 10-20 GB                 │
# │  - TTE: 5-10 GB                        │
# │  - VidCon: 10-20 GB                    │
# │  - Redis: 5 GB                         │
# │  - RabbitMQ: 5 GB                      │
# │                                        │
# │  System: 20 GB                         │
# └────────────────────────────────────────┘
#
# ┌────────────────────────────────────────┐
# │  External Database VM (32 GB RAM)      │
# ├────────────────────────────────────────┤
# │  MySQL: 28 GB (InnoDB buffer pool)     │
# │  OS: 4 GB                              │
# │                                        │
# │  FIXED - tidak terpengaruh K8s scaling │
# └────────────────────────────────────────┘
#
# Total: 132 GB RAM
# Jika database di K8s: Butuh ~150-180 GB (overhead)

---
# LimitRange: Default limits per container
apiVersion: v1
kind: LimitRange
metadata:
  name: default-limits
  namespace: layanan-prod
spec:
  limits:
  # Default untuk containers tanpa resource specs
  - max:
      cpu: "2"
      memory: "2Gi"
    min:
      cpu: "50m"
      memory: "64Mi"
    default:
      cpu: "500m"
      memory: "512Mi"
    defaultRequest:
      cpu: "250m"
      memory: "256Mi"
    type: Container

  # Limits untuk persistent volumes
  - max:
      storage: "10Gi"
    min:
      storage: "1Gi"
    type: PersistentVolumeClaim

---
# Priority Classes: Prioritize critical services
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000
globalDefault: false
description: "High priority for critical services"

---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: low-priority
value: 100
globalDefault: false
description: "Low priority for background jobs"

---
# Deployment dengan Priority
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: layanan-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      priorityClassName: high-priority  # Critical service!

      containers:
      - name: auth-service
        image: auth-service:latest
        resources:
          requests:
            cpu: "500m"      # Guaranteed resources
            memory: "512Mi"
          limits:
            cpu: "1000m"     # Max burst
            memory: "1Gi"

# ============================================
# Resource Efficiency Comparison
# ============================================
#
# Scenario: 5 microservices, each with 3 replicas
#
# Option A: Database di K8s
# ├── App pods: 15 pods × 512MB = 7.5 GB
# ├── DB pods: 5 pods × 2GB = 10 GB
# ├── Overhead: ~30%
# └── Total: ~23 GB
#
# Option B: External Database
# ├── App pods: 15 pods × 512MB = 7.5 GB
# ├── DB: 0 (external VM)
# ├── Overhead: ~20%
# └── Total in K8s: ~9 GB
#     + External DB VM: 8 GB
#     = Total: 17 GB
#
# Savings: ~26% overall + better DB performance
