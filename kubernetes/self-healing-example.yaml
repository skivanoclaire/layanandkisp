# ============================================
# Self-Healing & Zero-Downtime Deployment
# dengan External Database
# ============================================

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: email-service
  namespace: layanan-prod
spec:
  replicas: 3

  # Rolling Update Strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # Create 1 extra pod during update
      maxUnavailable: 0  # Never have less than 3 pods running

  selector:
    matchLabels:
      app: email-service

  template:
    metadata:
      labels:
        app: email-service
        version: v1.2.0  # Track version
    spec:
      containers:
      - name: email-service
        image: registry.example.com/email-service:v1.2.0

        # Database connection
        env:
          - name: DB_HOST
            value: "mysql-external"  # External DB service
          - name: DB_PORT
            value: "3306"

        # Liveness Probe: Restart pod jika tidak healthy
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3  # Restart after 3 failed checks

        # Readiness Probe: Remove dari load balancer jika not ready
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2

        # Startup Probe: Give time for slow startup
        startupProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 30  # 30*10 = 300s max startup time

        # Graceful Shutdown
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]

      # Termination grace period
      terminationGracePeriodSeconds: 30

      # Pod Disruption Budget (untuk maintenance)
      # Defined below

---
# Pod Disruption Budget
# Ensure minimal availability during cluster maintenance
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: email-service-pdb
  namespace: layanan-prod
spec:
  minAvailable: 2  # Always keep at least 2 pods running
  selector:
    matchLabels:
      app: email-service

# ============================================
# Bagaimana Self-Healing Bekerja?
# ============================================
#
# Scenario 1: Pod Crash
# 1. Pod crash/unhealthy → Liveness probe fails
# 2. Kubernetes restart pod otomatis
# 3. New pod connect ke External DB (connection restored)
# 4. Readiness probe OK → Back in service
# ⏱️ Downtime: ~30 seconds (only that pod)
#
# Scenario 2: Database Connection Lost
# 1. External DB unreachable (network issue)
# 2. Health check fail → Pod marked unhealthy
# 3. Kubernetes restart pod (retry connection)
# 4. If DB still down → Pods keep restarting (CrashLoopBackOff)
# 5. When DB restored → Pods auto-recover
#
# Scenario 3: Deployment Update
# 1. Deploy new version (v1.2.0 → v1.3.0)
# 2. K8s create 1 new pod (v1.3.0)
# 3. New pod connects to External DB
# 4. Readiness check pass → Add to service
# 5. Terminate 1 old pod (v1.2.0)
# 6. Repeat until all updated
# ⏱️ Zero downtime!
#
# Database Connection Pool Handling:
# - Old pod close connections → Freed in MySQL
# - New pod create new connections → Reuse from pool
# - Connection count stays predictable

---
# Init Container: Wait for database ready
apiVersion: apps/v1
kind: Deployment
metadata:
  name: email-service-with-init
  namespace: layanan-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: email-service
  template:
    metadata:
      labels:
        app: email-service
    spec:
      # Init Container: Check DB before starting app
      initContainers:
      - name: wait-for-db
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for database to be ready..."
          until nc -z mysql-external 3306; do
            echo "Database not ready, waiting..."
            sleep 2
          done
          echo "Database is ready!"

      containers:
      - name: email-service
        image: registry.example.com/email-service:latest
        env:
          - name: DB_HOST
            value: "mysql-external"
