# ============================================
# Horizontal Pod Autoscaler
# Scale aplikasi berdasarkan CPU/Memory usage
# Database eksternal TIDAK terpengaruh
# ============================================

---
# HPA untuk Email Service
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: email-service-hpa
  namespace: layanan-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: email-service
  minReplicas: 2      # Minimum 2 pods
  maxReplicas: 10     # Maximum 10 pods
  metrics:
  # Scale based on CPU
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # Scale up jika CPU > 70%

  # Scale based on Memory
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # Scale up jika Memory > 80%

  # Scale based on Custom Metrics (contoh: request count)
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "100"  # Scale jika > 100 req/s per pod

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 min before scale down
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60   # Quick scale up (1 min)
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60

# ============================================
# Bagaimana Ini Bekerja dengan External DB?
# ============================================

# Scenario: Traffic meningkat
#
# 1. User traffic naik → CPU/Memory pods naik
# 2. HPA detect → scale dari 2 pods jadi 5 pods
# 3. Semua 5 pods connect ke MYSQL EKSTERNAL yang sama
# 4. Database handle multiple connections (max_connections=200)
# 5. Connection pooling handle load distribution
#
# Keuntungan:
# ✅ Aplikasi scale horizontal (2 → 10 pods)
# ✅ Database tetap 1 server (predictable performance)
# ✅ Database bisa di-tune untuk high connections
# ✅ Biaya database tidak ikut scale

---
# VPA (Vertical Pod Autoscaler) - Optional
# Auto-adjust CPU/Memory requests per pod
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: email-service-vpa
  namespace: layanan-prod
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: email-service
  updatePolicy:
    updateMode: "Auto"  # Automatically apply recommendations
